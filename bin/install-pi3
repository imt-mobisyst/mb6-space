#!/bin/bash

## Clone mb6-space
cd
if [ ! -d "mb6-space" ]; then
  git config --global http.sslverify false
  git clone https://bitbucket.org/imt-mobisyst/mb6-space.git
fi
cd mb6-space

## Time Syncronisation:
sudo cp deps/timesyncd.conf /etc/systemd/
sudo service systemd-timesyncd restart

## Some Softs:
# sudo cp deps/install-pi3-needrestart.conf /etc/needrestart/needrestart.conf
sudo apt update
sudo apt remove -y cloud-init
sudo apt install -y build-essential meld

### DHCP Server on Eth0:
# TODO

### Disable the : networkd-wait-online.service
sudo systemctl disable systemd-networkd-wait-online.service
sudo systemctl mask systemd-networkd-wait-online.service

### install ROS2 :
export ROSDISTRO=iron
bin/install-ros-setup

echo "
                    --- Install ros-$ROSDISTRO for Pi3 ---
"

sudo apt install -y \
  ros-$ROSDISTRO-ros-base \
  ros-$ROSDISTRO-urg-node

sudo usermod -a -G dialout `whoami`

source /opt/ros/iron/setup.bash
colcon build

# Configure the environemnt
echo "

# mb6 ROS environment:
source ~/mb6-space/bin/pibot-run-commands.bash" >> ~/.bashrc

git clone https://bitbucket.org/imt-mobisyst/pkg-basic.git
git clone https://bitbucket.org/imt-mobisyst/pkg-tbot.git
./pkg-tbot/bin/install

# Get prebuild pibot
rm -fr install
git checkout pibot

# Init auto login: https://wiki.archlinux.org/title/Getty

sudo mkdir /etc/systemd/system/getty@tty1.service.d
echo "[Service]
ExecStart=
ExecStart=-/sbin/agetty -o '-p -f -- \\u' --noclear --autologin bot %I $TERM
" > autologin.conf
sudo mv autologin.conf /etc/systemd/system/getty@tty1.service.d/

# Activate services
./bin/set-parasit-as-a-service
./bin/set-tbot-as-a-service

# Finalize:
sudo apt upgrade -y
sudo reboot